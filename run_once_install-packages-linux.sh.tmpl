#!/bin/bash
{{ if ne .chezmoi.os "linux" }}
exit 0
{{ end }}

set -euo pipefail

# ── Color helpers ─────────────────────────────────────────────────────────
info()  { printf '\033[1;34m[INFO]\033[0m  %s\n' "$*"; }
warn()  { printf '\033[1;33m[WARN]\033[0m  %s\n' "$*"; }
ok()    { printf '\033[1;32m[ OK ]\033[0m  %s\n' "$*"; }
err()   { printf '\033[1;31m[ERR ]\033[0m  %s\n' "$*"; }

# ── Require dnf ───────────────────────────────────────────────────────────
if ! command -v dnf >/dev/null 2>&1; then
    err "dnf not found — this script is for Fedora / RHEL-based distros."
    exit 1
fi

MISSING=()

# ── 1. Core DNF packages ─────────────────────────────────────────────────
info "Installing core packages via dnf …"
sudo dnf install -y \
    bat \
    btop \
    fontconfig \
    fzf \
    git-filter-repo \
    git-lfs \
    isync \
    librsvg2-tools \
    mosh \
    msmtp \
    ncdu \
    neomutt \
    pandoc \
    poppler-utils \
    ripgrep \
    tigervnc \
    tmux \
    vim-enhanced \
    wireguard-tools \
    zoxide \
    zsh \
    zsh-autosuggestions \
    zsh-syntax-highlighting \
    texlive-scheme-basic
ok "Core dnf packages installed."

# ── 2. GitHub CLI (gh) ───────────────────────────────────────────────────
install_gh() {
    if command -v gh >/dev/null 2>&1; then
        ok "gh already installed."
        return
    fi
    info "Adding GitHub CLI repo …"
    sudo dnf config-manager --add-repo \
        https://cli.github.com/packages/rpm/gh-cli.repo
    sudo dnf install -y gh
    ok "gh installed."
}
install_gh

# ── 3. Docker CE ─────────────────────────────────────────────────────────
install_docker() {
    if command -v docker >/dev/null 2>&1; then
        ok "Docker already installed."
        return
    fi
    info "Adding Docker repo …"
    sudo dnf config-manager --add-repo \
        https://download.docker.com/linux/fedora/docker-ce.repo
    sudo dnf install -y \
        docker-ce \
        docker-ce-cli \
        containerd.io \
        docker-buildx-plugin \
        docker-compose-plugin
    ok "Docker installed."
}
install_docker

# ── 4. VS Code ───────────────────────────────────────────────────────────
install_vscode() {
    if command -v code >/dev/null 2>&1; then
        ok "VS Code already installed."
        return
    fi
    info "Adding Microsoft VS Code repo …"
    sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
    printf '[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc\n' \
        | sudo tee /etc/yum.repos.d/vscode.repo >/dev/null
    sudo dnf install -y code
    ok "VS Code installed."
}
install_vscode

# ── 5. Official install scripts ──────────────────────────────────────────
install_chezmoi() {
    if command -v chezmoi >/dev/null 2>&1; then
        ok "chezmoi already installed."
        return
    fi
    info "Installing chezmoi …"
    curl -fsLS get.chezmoi.io | sh
    ok "chezmoi installed."
}
install_chezmoi

install_starship() {
    if command -v starship >/dev/null 2>&1; then
        ok "starship already installed."
        return
    fi
    info "Installing starship …"
    curl -sS https://starship.rs/install.sh | sh -s -- --yes
    ok "starship installed."
}
install_starship

install_uv() {
    if command -v uv >/dev/null 2>&1; then
        ok "uv already installed."
        return
    fi
    info "Installing uv …"
    curl -LsSf https://astral.sh/uv/install.sh | sh
    ok "uv installed."
}
install_uv

# ── 6. JetBrains Mono Nerd Font ──────────────────────────────────────────
install_nerd_font() {
    local font_dir="$HOME/.local/share/fonts"
    if ls "$font_dir"/JetBrains*Nerd* >/dev/null 2>&1; then
        ok "JetBrains Mono Nerd Font already installed."
        return
    fi
    info "Installing JetBrains Mono Nerd Font …"
    mkdir -p "$font_dir"
    local tmp
    tmp="$(mktemp -d)"
    curl -fsSL -o "$tmp/JetBrainsMono.tar.xz" \
        "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.tar.xz"
    tar -xf "$tmp/JetBrainsMono.tar.xz" -C "$font_dir"
    rm -rf "$tmp"
    fc-cache -f "$font_dir"
    ok "JetBrains Mono Nerd Font installed."
}
install_nerd_font

# ── 7. Check for tools that can't be auto-installed ──────────────────────
check_tool() {
    local cmd="$1" instruction="$2"
    if ! command -v "$cmd" >/dev/null 2>&1; then
        MISSING+=("$cmd  →  $instruction")
    fi
}

check_tool eza        "cargo install eza"
check_tool glow       "go install github.com/charmbracelet/glow@latest"
check_tool mdcat      "cargo install mdcat"
check_tool oauth2l    "go install github.com/google/oauth2l@latest"
check_tool surfer     "Manual install (waveform viewer)"
check_tool claude     "npm install -g @anthropic-ai/claude-code"
check_tool joplin     "flatpak install flathub net.cozic.joplin_desktop"

# ── 8. Summary ────────────────────────────────────────────────────────────
echo
info "════════════════════════════════════════════════════"
info "  Linux package installation complete"
info "════════════════════════════════════════════════════"

if [ ${#MISSING[@]} -gt 0 ]; then
    echo
    warn "The following tools are NOT installed and need manual action:"
    for entry in "${MISSING[@]}"; do
        warn "  • $entry"
    done
    echo
    warn "Note: eza is used by ~/.zsh_functions.common for ls/ll aliases"
    warn "      (guarded with 'command -v', so shell will still work)."
fi

echo
info "Skipped macOS-only tools (no Linux equivalent):"
info "  • ChatGPT (cask)"
info "  • GitHub Desktop (cask)"
info "  • iTerm2 (cask)"
info "  • itermAI (cask)"
info "  • Karabiner Elements (cask)"
info "  • Rectangle (cask)"

echo
ok "Done."
